<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>FastStile â€“ Economia Inteligente</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
 --primary:#0d6efd;
 --success:#198754;
 --warning:#ffc107;
 --danger:#dc3545;
 --bg:#f4f6f8;
 --card:#ffffff;
}
.dark{
 --bg:#121212;
 --card:#1e1e1e;
 color:#fff;
}
*{box-sizing:border-box}
body{
 margin:0;
 font-family:Arial,Helvetica,sans-serif;
 background:var(--bg);
}
header{
 background:var(--primary);
 color:#fff;
 padding:15px;
 text-align:center;
}
.card{
 background:var(--card);
 margin:10px;
 padding:15px;
 border-radius:14px;
 box-shadow:0 2px 6px rgba(0,0,0,.1);
}
button,input,select{
 width:100%;
 padding:12px;
 margin:6px 0;
 border-radius:10px;
 border:1px solid #ccc;
 font-size:15px;
}
button{
 background:var(--primary);
 color:#fff;
 border:none;
}
.hidden{display:none}
.kpis{
 display:grid;
 grid-template-columns:repeat(2,1fr);
 gap:10px;
}
.kpi{
 text-align:center;
 padding:10px;
 border-radius:12px;
 background:#e9ecef;
}
.badge{
 display:inline-block;
 padding:6px 12px;
 border-radius:20px;
 background:gold;
 font-weight:bold;
}
.alert{
 background:var(--danger);
 color:#fff;
 padding:10px;
 border-radius:10px;
}
small{opacity:.8}
</style>
</head>

<body>

<header>
<h2>FastStile</h2>
<small>Economia Inteligente</small>
</header>

<!-- LOGIN -->
<div id="login" class="card">
<h3>ğŸ” Acesso Seguro</h3>
<input id="user" placeholder="Nome do perfil">
<input id="pin" type="password" placeholder="PIN">
<button onclick="login()">Entrar / Criar Perfil</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

<div class="card">
<button onclick="toggleDark()">ğŸŒ™ Dark Mode</button>
</div>

<div class="card">
<h3>ğŸ“Š Dashboard Inteligente</h3>
<div class="kpis">
 <div class="kpi"><small>Renda</small><h3 id="renda"></h3></div>
 <div class="kpi"><small>Despesas</small><h3 id="desp"></h3></div>
 <div class="kpi"><small>Sobra</small><h3 id="sobra"></h3></div>
 <div class="kpi"><small>Status</small><h3 id="status"></h3></div>
</div>
<br>
<div id="badge" class="badge hidden">ğŸ† Financeiro Exemplar</div>
<div id="alerta" class="alert hidden"></div>
</div>

<div class="card"><canvas id="grafPizza"></canvas></div>
<div class="card"><canvas id="grafBar"></canvas></div>

<div class="card">
<h3>ğŸ¯ Meta Mensal</h3>
<input type="number" id="meta" placeholder="Valor da meta">
<button onclick="salvarMeta()">Salvar Meta</button>
</div>

<div class="card">
<h3>â• Nova Despesa</h3>
<select id="cat">
<option>DZ</option>
<option>AlimentaÃ§Ã£o + Feira</option>
<option>Internet</option>
<option>Telefone</option>
<option>Moradia</option>
<option>INSS</option>
<option>RemÃ©dio</option>
<option>Pet</option>
<option>CombustÃ­vel</option>
</select>
<input type="number" id="val" placeholder="Valor da despesa">
<button onclick="addDespesa()">Adicionar</button>
</div>

<div class="card">
<h3>ğŸ“ Dados</h3>
<button onclick="exportCSV()">Exportar CSV</button>
<input type="file" onchange="importCSV(event)">
<button onclick="backup()">Backup Local</button>
<input type="file" onchange="restore(event)">
</div>

</div>

<script>
let perfil=null, chartPizza=null, chartBar=null;

async function hash(txt){
 const buf=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(txt));
 return [...new Uint8Array(buf)].map(x=>x.toString(16).padStart(2,"0")).join("");
}

async function login(){
 const u=user.value.trim();
 const p=pin.value;
 if(!u||!p)return;
 const h=await hash(p);
 const db=JSON.parse(localStorage.users||"{}");

 if(!db[u]){
   db[u]={pin:h,data:{renda:4299.22,meta:0,despesas:[],mes:new Date().getMonth()}};
 }
 if(db[u].pin!==h)return alert("PIN incorreto");

 localStorage.users=JSON.stringify(db);
 perfil=u;
 loginDiv();
}

function loginDiv(){
 login.classList.add("hidden");
 app.classList.remove("hidden");
 render();
}

function getData(){
 return JSON.parse(localStorage.users)[perfil].data;
}
function saveData(d){
 const db=JSON.parse(localStorage.users);
 db[perfil].data=d;
 localStorage.users=JSON.stringify(db);
}

function addDespesa(){
 const d=getData();
 d.despesas.push({c:cat.value,v:+val.value,data:Date.now()});
 saveData(d);
 render();
}

function salvarMeta(){
 const d=getData();
 d.meta=+meta.value;
 saveData(d);
 render();
}

function render(){
 const d=getData();
 const total=d.despesas.reduce((a,b)=>a+b.v,0);
 const sobra=d.renda-total;

 renda.innerText=`R$ ${d.renda.toFixed(2)}`;
 desp.innerText=`R$ ${total.toFixed(2)}`;
 sobra.innerText=`R$ ${sobra.toFixed(2)}`;

 let statusTxt="OK";
 alerta.classList.add("hidden");

 if(d.meta && sobra<d.meta){
   statusTxt="Meta em risco";
   alerta.innerText="âš ï¸ AtenÃ§Ã£o: vocÃª estÃ¡ abaixo da meta!";
   alerta.classList.remove("hidden");
 }
 if(sobra<0){
   statusTxt="PrejuÃ­zo";
 }

 status.innerText=statusTxt;

 badge.classList.toggle("hidden",sobra<1000);

 const map={};
 d.despesas.forEach(x=>map[x.c]=(map[x.c]||0)+x.v);

 if(chartPizza)chartPizza.destroy();
 if(chartBar)chartBar.destroy();

 chartPizza=new Chart(grafPizza,{
   type:"pie",
   data:{labels:Object.keys(map),datasets:[{data:Object.values(map)}]}
 });

 chartBar=new Chart(grafBar,{
   type:"bar",
   data:{labels:Object.keys(map),datasets:[{data:Object.values(map)}]}
 });
}

function exportCSV(){
 const d=getData();
 let csv="Categoria,Valor\n";
 d.despesas.forEach(x=>csv+=`${x.c},${x.v}\n`);
 download(csv,"faststile.csv");
}

function importCSV(e){
 const r=new FileReader();
 r.onload=()=>{
   const d=getData();
   r.result.split("\n").slice(1).forEach(l=>{
     const [c,v]=l.split(",");
     if(c&&v)d.despesas.push({c,v:+v,data:Date.now()});
   });
   saveData(d);render();
 };
 r.readAsText(e.target.files[0]);
}

function backup(){
 const d=getData();
 download(JSON.stringify(d),"faststile-backup.json");
}
function restore(e){
 const r=new FileReader();
 r.onload=()=>{
   saveData(JSON.parse(r.result));
   render();
 };
 r.readAsText(e.target.files[0]);
}

function download(content,name){
 const a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([content]));
 a.download=name;
 a.click();
}

function toggleDark(){
 document.body.classList.toggle("dark");
}

if("serviceWorker"in navigator){
 navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>